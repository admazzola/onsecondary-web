<template>

<div>

   <div class="section bg-gray-200  border-b-2 border-black  lg:px-1 ">

     <div class=" ">
        <Navbar 
        v-bind:web3Plug="web3Plug" 
       />
     </div>


   </div>

  

   <div class="section  bg-white border-b-2 border-black">
     <div class="py-16 w-container">
        
       <div class="  px-2 ">
          <div class="text-lg font-bold mb-4"> Stake to Earn  </div>

          <div class="text-sm mb-8"> Deposit SOS in the Club SOS contract to earn 'Club Reserve tokens'. Club Reserve tokens can be redeemed back to the contract to withdraw your original deposit plus any fees that the contract has accrued from marketing sponsors.   </div>
           
          <div  class=" " v-if="!connectedToWeb3">
              <NotConnectedToWeb3 />
          </div>

          <div  class=" px-4" v-if=" connectedToWeb3">
 
  
            
 

              
           <div class="mb-4 inline-block ">
             <div class="flex flex-row">
              <label   class="block text-md font-medium font-bold text-gray-800  ">Deposit Amount</label>
                  <div class="flex-grow"></div>
                <label   class="block text-xs font-xs text-blue-500  ">Balance:   {{tokenBalanceFormatted}}</label>

            </div>
              <div class="flex flex-row">
              <div class="w-f ">
                    <input type="number" 
                    @input="clearErrorMessage()"
                     v-model="formInputs.currencyAmountFormatted" 
                      class="text-gray-900 border-2 border-black font-bold px-4 text-xl focus:ring-indigo-500 focus:border-indigo-500 block w-full py-4 pl-7 pr-12   border-gray-300 rounded-md" 
                      placeholder="0.00">
                </div> 
                 
              </div>
           
            </div>

 
 

          </div>


             <div class="py-4" v-if=" connectedToWeb3 && !submitComplete"> 
             
                 <div class="  p-4 bg-red-600 rounded text-white font-bold" v-if="errorMessage">
                   

                  Error:  {{errorMessage}}
               
                </div> 
 
               

          </div>


           <div class="py-4" v-if=" connectedToWeb3 && !submitComplete"> 
             
                 <div class="  p-4" v-if="!networkSupportsApproveAndCall()">
                   

                     <div v-if="!hasEnoughAllowance()"  @click="approveClicked" class="select-none bg-green-700 p-2 inline-block rounded hover:bg-green-900 border-gray-800 border-2 cursor-pointer text-white" style=" text-shadow: 1px 1px #222;"> Approve </div>
               
                    <label   class="block text-md  text-black inline-block px-2 ">Allowance:   {{tokenAllowanceFormatted}}</label>

               
                </div> 
 
                 <div class="  p-4">
                     <div @click="depositClicked" class="select-none bg-blue-700 p-2 inline-block rounded hover:bg-blue-900 border-gray-800 border-2 cursor-pointer text-white" style=" text-shadow: 1px 1px #222;"> Deposit </div>
                </div> 

          </div>



         


          
       </div>
     </div>
   </div>

  <div class="section  text-white  border-b-2 border-black " style="background:#222;">
     <div class="w-container  ">

         

          <div class=" w-2/3  mt-8 py-8" style="margin: 0 auto;">
           
                <div class="text-2xl text-center"> How It Works </div>

                

                <ul class=" "> 
                    <li class="my-4"> 1. SOS is staked in the 'Club SOS' Contract </li>
                    <li class="my-4" > 2. Web3 applications such as OnSecondary Exchanges donate some of their income to the 'Club SOS' Contract as revenue-share to use as a marketing+branding boost to all SOS holders </li>
                    <li class="my-4" > 3. Unstake SOS at any time to withdraw <span class="text-purple-300"> your original deposit + accrued donations </span>  </li>
               </ul>

                <div class="text-lg text-center my-16  "> TLDR: This is donations router for community-driven marketing and incentivization. </div>


                <p class="text-gray-500 bg-gray-800 p-4 mt-8"> <img src="@/assets/images/information.png" width="20" class="inline"/> Services perform revenue-share to the Club contract to incentivize SOS holders to participate and market their application since this gives SOS holders a financial interest in the application's success. </p>

         </div>

        
         


     </div>
   </div>

    


    
  <Footer/>

</div>
</template>


<script>



import NotConnectedToWeb3 from './components/NotConnectedToWeb3.vue'

import Web3Plug from '../js/web3-plug.js'  
 import MathHelper from '../js/math-helper.js'  
 
 import {BN} from 'web3-utils'
 
import Navbar from './components/Navbar.vue';
 
import Footer from './components/Footer.vue';
import TabsBar from './components/TabsBar.vue';
import GenericTable from './components/GenericTable.vue';
import GenericDropdown from './components/GenericDropdown.vue';
  
const ClubContractABI = require('../contracts/ClubSOS.json')

import FrontendHelper from '../js/frontend-helper.js'


var balanceInterval

export default {
  name: 'Stake',
  props: [],
  components: {Navbar, Footer, TabsBar, GenericTable, GenericDropdown,NotConnectedToWeb3},
  data() {
    return {
      web3Plug: new Web3Plug() , 
  
      formInputs:{},

      tokenBalanceRaw: null,
      tokenBalanceFormatted: null,

      tokenAllowanceRaw: null,
      tokenAllowanceFormatted: null,
       
      connectedToWeb3: false ,
      submitComplete:false,
      errorMessage: undefined 
    }
  },

  created(){

 
    this.web3Plug.getPlugEventEmitter().on('stateChanged', async function(connectionState) {
        console.log('stateChanged',connectionState);
         
        this.activeAccountAddress = connectionState.activeAccountAddress
        this.activeNetworkId = connectionState.activeNetworkId
        this.connectedToWeb3 = this.web3Plug.connectedToWeb3()
        
            await this.fetchBalance()
         
      }.bind(this));
   this.web3Plug.getPlugEventEmitter().on('error', function(errormessage) {
        console.error('error',errormessage);
         
        this.web3error = errormessage
       
      }.bind(this));

      this.web3Plug.reconnectWeb()
    
 

  },
   mounted: async function () {

    let chainId = this.web3Plug.getActiveNetId()
     
    balanceInterval = setInterval(this.fetchBalance,8000)
    
  }, 
  beforeDestroy(){
    clearInterval(balanceInterval)
  },
  methods: {


    async approveClicked(){
         

      let accountAddress = this.web3Plug.getActiveAccountAddress()

      let chainId = this.web3Plug.getActiveNetId()
      let guildContractAddress = this.web3Plug.getContractDataForNetworkID(chainId)['clubsos'].address

       let tokenContractAddress = this.web3Plug.getContractDataForNetworkID(chainId)['sos'].address

      let currencyDecimals  = 18 
      let currencyAmountRaw = MathHelper.formattedAmountToRaw(this.formInputs.currencyAmountFormatted,currencyDecimals) 
 
      let tokenContract = this.web3Plug.getTokenContract( tokenContractAddress );
     
      
      
       let response = await tokenContract.methods.approve(guildContractAddress, currencyAmountRaw ).send({from:  accountAddress })
      


    },
 
    async depositClicked(){
      console.log('start deposit ')


      let accountAddress = this.web3Plug.getActiveAccountAddress()

      let chainId = this.web3Plug.getActiveNetId()
      let guildContractAddress = this.web3Plug.getContractDataForNetworkID(chainId)['clubsos'].address

       let tokenContractAddress = this.web3Plug.getContractDataForNetworkID(chainId)['sos'].address

      let currencyDecimals  = 18 
      let currencyAmountRaw = MathHelper.formattedAmountToRaw(this.formInputs.currencyAmountFormatted,currencyDecimals) 
  

       let currencyAmountBN = new BN( currencyAmountRaw ) 
       let minStakeCoins = '100'
       let minimumToStake = new BN( minStakeCoins ).mul( new BN('1000000000000000000')   )

       
      if(currencyAmountBN.lt( minimumToStake ) ){
        let errorMessage = 'Must stake at least '.concat(parseInt(minStakeCoins)).concat(' tokens.')

        this.setErrorMessage( errorMessage )
        console.error(errorMessage)
        return 
      } 

      let tokenContract = this.web3Plug.getTokenContract( tokenContractAddress );
     
      let guildContract  = this.web3Plug.getCustomContract( ClubContractABI , guildContractAddress );

    
      
        let response = await guildContract.methods.stakeCurrency( accountAddress, currencyAmountRaw ).send({from:  accountAddress })
      
      
    },


    async fetchBalance(){
       let chainId = this.web3Plug.getActiveNetId()
      let accountAddress = this.web3Plug.getActiveAccountAddress()

     
      let tokenContractAddress = this.web3Plug.getContractDataForNetworkID(chainId)['sos'].address

       let guildContractAddress = this.web3Plug.getContractDataForNetworkID(chainId)['clubsos'].address

      this.tokenBalanceRaw = await  this.web3Plug.getTokenBalance(tokenContractAddress, accountAddress)

      this.tokenAllowanceRaw = await  this.web3Plug.getTokenAllowance(tokenContractAddress,guildContractAddress, accountAddress)

     // console.log('tokenBalanceRaw', tokenBalanceRaw )

      this.tokenBalanceFormatted = parseFloat(   MathHelper.rawAmountToFormatted(this.tokenBalanceRaw  , 18  ) )
      this.tokenAllowanceFormatted = parseFloat(   MathHelper.rawAmountToFormatted(this.tokenAllowanceRaw  , 18  ) )

    },

    setErrorMessage(msg){
      this.errorMessage = msg
    },

    clearErrorMessage(){
      this.errorMessage = undefined
    },


    networkSupportsApproveAndCall(){

      

      return false
    },

    hasEnoughAllowance(){
      let currencyDecimals = 18
      let currencyAmountRaw = MathHelper.formattedAmountToRaw(this.formInputs.currencyAmountFormatted,currencyDecimals) 
 
      return (this.tokenAllowanceRaw >= currencyAmountRaw);
    }
          
  }
}
</script>
